- name: install instack-undercloud
  yum:
    name: instack-undercloud
    state: installed

- name: set instack_host_env
  set_fact:
    instack_host_env: |
      export NODE_DIST={{ instack_host_node_dist }}
      {% if instack_host_node_dist | match('^rhel') %}
        export RHOS=1
        export DIB_YUM_REPO_CONF={{ instack_host_dib_yum_repo }}
        export DIB_CLOUD_IMAGES={{ instack_host_dib_cloud_images }}
        export BASE_IMAGE_FILE={{ instack_host_dib_base_image }}
        export REG_METHOD=disable
        export REG_HALT_UNREGISTER=1
      {% endif %}
      export LIBVIRT_VOL_POOL={{ instack_host_libvirt_storage_pool }}
      source /usr/libexec/openstack-tripleo/devtest_variables.sh
      {{ instack_host_env_extra if instack_host_env_extra is defined }}

- name: install instack dependencies
  shell: |
    {{ instack_host_env }}
    tripleo install-dependencies
  args:
    chdir: "{{ stack_user_home }}"
  sudo: yes
  sudo_user: stack

- name: fact instack_vm_defined
  shell: virsh list --all | grep instack
  failed_when: false
  changed_when: false
  register: instack_vm_defined

- name: run instack-virt-setup
  shell: |
    {{ instack_host_env }}
    instack-virt-setup 2>&1 | tee /tmp/instack-virt-setup.out
  args:
    chdir: "{{ stack_user_home }}"
  sudo: yes
  sudo_user: stack
  when: instack_vm_defined.rc != 0
